#!/usr/bin/expect -f

# Set timeout for commands
set timeout 30

# Start QEMU with the kernel
spawn qemu-system-i386 -kernel /app/kernel -nographic -monitor none

# Wait for the system to boot and show the shell prompt
expect {
    "pepin$ " {
        puts "âœ… System booted successfully and shell prompt appeared"
    }
    timeout {
        puts "âŒ System failed to boot or shell prompt not found"
        exit 1
    }
}

# Test help command
send "help\r"
expect {
    "Available commands:" {
        puts "âœ… Help command works"
    }
    timeout {
        puts "âŒ Help command failed"
        exit 1
    }
}

expect "pepin$ "

# Test ls command
send "ls\r"
expect {
    -re "(readme\.txt|Files in root directory)" {
        puts "âœ… ls command works"
    }
    timeout {
        puts "âŒ ls command failed"
        exit 1
    }
}

expect "pepin$ "

# Test echo command
send "echo test message\r"
expect {
    "test message" {
        puts "âœ… echo command works"
    }
    timeout {
        puts "âŒ echo command failed"
        exit 1
    }
}

expect "pepin$ "

# Test cat command (try to read readme.txt)
send "cat readme.txt\r"
expect {
    -re "(Welcome|This is|readme)" {
        puts "âœ… cat command works"
    }
    "Cannot open file" {
        puts "âš ï¸  cat command works but readme.txt not found"
    }
    timeout {
        puts "âŒ cat command failed"
        exit 1
    }
}

expect "pepin$ "

# Test create command
send "create testfile.txt 50\r"
expect {
    "File created: testfile.txt" {
        puts "âœ… create command works"
    }
    timeout {
        puts "âŒ create command failed"
        exit 1
    }
}

expect "pepin$ "

# Test write command
send "write testfile.txt \"hello world\"\r"
expect {
    "Text written to testfile.txt" {
        puts "âœ… write command works"
    }
    timeout {
        puts "âŒ write command failed"
        exit 1
    }
}

expect "pepin$ "

# Test reading the file we just created
send "cat testfile.txt\r"
expect {
    "hello world" {
        puts "âœ… File operations work correctly"
    }
    timeout {
        puts "âŒ File read after write failed"
        exit 1
    }
}

expect "pepin$ "

# Test exec command with hello.elf
send "exec hello.elf\r"
expect {
    "Hello from user program!" {
        puts "âœ… ELF execution works"
    }
    timeout {
        puts "âŒ ELF execution failed"
        exit 1
    }
}

expect "pepin$ "

# Test ps command
send "ps\r"
expect {
    "Process information:" {
        puts "âœ… ps command works"
    }
    timeout {
        puts "âŒ ps command failed"
        exit 1
    }
}

expect "pepin$ "

# Test mem command
send "mem\r"
expect {
    "Memory information:" {
        puts "âœ… mem command works"
    }
    timeout {
        puts "âŒ mem command failed"
        exit 1
    }
}

expect "pepin$ "

# Test clear command
send "clear\r"
expect {
    "pepin$ " {
        puts "âœ… clear command works"
    }
    timeout {
        puts "âŒ clear command failed"
        exit 1
    }
}

# Test tasks command (optional multitasking demo)
send "tasks\r"
expect {
    -re "(Background tasks|already running)" {
        puts "âœ… tasks command works"
    }
    timeout {
        puts "âŒ tasks command failed"
        exit 1
    }
}

expect "pepin$ "

puts "\nğŸ‰ All tests completed successfully!"
puts "Pepin OS is working as expected"

# Exit QEMU
send "\x01x"
expect eof